---
title: "hydro_climate_trends"
author: "Nick Gubbins"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages.
library(here)
library(tidyverse)
library(ggplot2)
library(naniar)
library(lubridate)
library(feather)
library(macrosheds)
library(moments)
library(feather)
library(lfstat)
library(trend)
library(ggrepel)
library(ggthemes)
library(viridis)

# Set directory to folder containing new data.
my_ms_dir <- "data_raw"

# fix package calls while using v2 ahead of release
#remove this if using the v2 dataset from the macrosheds package proper
rdata_path <- my_ms_dir
load(file.path(rdata_path, 'ms_site_data.RData'))
load(file.path(rdata_path, 'ms_vars_ws_attr.RData'))
load(file.path(rdata_path, 'ms_vars_ts.RData'))
load(file.path(rdata_path, 'ms_var_catalog.RData'))

nv <- as.environment('package:macrosheds')

for(ms_data in c('ms_vars_ts', 'ms_vars_ws', 'ms_site_data', 'ms_var_catalog')){
    unlockBinding(ms_data, nv)
    assign(ms_data, get(ms_data), envir = nv)
    lockBinding(ms_data, nv)
}
```
# Trend detection

## Reading in and summarizing data.

First reading in summary data and work that Heili already did.

```{r}
#from MS
ws_sums <- read_feather(here('data_raw', 'watershed_summaries.feather'))
hydro <- read_feather(here('data_raw', 'spatial_timeseries_hydrology.feather'))
### this next one will take a minute
clim <- read_feather(here('data_raw', 'spatial_timeseries_climate.feather')) %>%
  mutate(year = year(date),
         month = month(date),
        water_year = case_when(month %in% c(10, 11, 12) ~ year+1,
                                TRUE ~ year)) %>%
    select(site_code, date, water_year, var, val) %>%
    pivot_wider(id_cols = c(site_code, date, water_year), 
                names_from = var, values_from = val, values_fn = mean) %>%
    group_by(site_code, water_year) %>%
    summarize(precip_mean_ann = mean(cc_precip_median, na.rm = T),
              precip_total_ann = sum(cc_precip_median, na.rm = T),
              temp_mean_ann = mean(cc_temp_mean_median, na.rm = T)
              )

# From q_metrics script
#if you haven't run it yet, just uncomment the next line to source it
#source('q_metrics.R')
q_metrics <- readRDS(here('data_working', 'discharge_7metrics_siteyear.rds'))
```


Next, join climate summaries to magnificent 7 from q_metrics script. 

```{r}
com <- q_metrics %>%
    full_join(clim, by = c('site_code', 'water_year'))
```

Perform trend detection at each site.

```{r}
com_long <- pivot_longer(com, cols = -c('site_code', 'water_year'), names_to = 'var', values_to = 'val')

# commenting out all this to save processing time
# uncomment and run to remake trends datset if needed
# out_frame <- tibble(site_code = as.character(),
#                     var = as.character(),
#                     start = as.integer(),
#                     end = as.integer(),
#                     trend = as.integer(),
#                     p = as.integer())
# 
# # for(i in unique(com_long$site_code)) {
# #     
#     target_site <- filter(com_long, site_code == i) 
#     
#     dat_check <- na.omit(target_site)
#     
#     if(nrow(dat_check) > 1){
#     #loop  through metrics
#     for(j in unique(target_site$var)){
#         
#     target_solute <- filter(target_site, var == j)  %>%
#         arrange(water_year) %>%
#         na.omit()
#         
#     if(nrow(target_solute) > 9){ 
#     start <- min(target_solute$water_year)
#     end <- max(target_solute$water_year)
#     n <- nrow(target_solute)
#     test <- sens.slope(target_solute$val)
#     trend <- test[[1]]
#     p <- test[[3]]
#     
#     
#     inner <- tibble(site_code = i,
#                     var = j,
#                     start = start,
#                     end = end,
#                     n = n,
#                     trend = trend,
#                     p = p
#                     )
#     out_frame <- rbind(out_frame, inner)
#     
#     diag <- ggplot(target_solute, aes(x = water_year, y = val)) +
#             labs(title = paste0(i, ' ', j),
#                       caption = paste0('n = ', n))+
#             geom_point()+
#         theme_few()
#     
#     quietly(ggsave(plot = diag, filename = here('data_working', 'diag_plots', i, paste0(i,'_',j,'.png')),
#            create.dir = T))
#     
#     
#     }else{next} #solute level data avail check
#         }# end solute loop
#     }else{next} # site level data avail check
# } #end site loop

#write_csv(out_frame, file = here('data_working', 'hydro_climate_trends.csv'))

#trends <- out_frame

# comment this out if you are using the loop to update data
trends <- read_csv(here('data_working', 'hydro_climate_trends.csv'))
```

# Figure creation

## Trend histograms/density plots

First want an idea of what data is in here. So going to make a quick table.

```{r}
com %>%
    left_join(., ms_site_data, by = 'site_code') %>%
    select(domain, site_code) %>%
    group_by(domain) %>%
    summarize(n = n_distinct(site_code))
```


Make kernel density plots for each trend. 

```{r}
trends %>%
    filter(p > 0.05, # sign trends only
           var != 'a_flow_sig',
            var != 'b_flow_sig') %>% 
ggplot(aes(x = trend))+
    geom_density()+
    facet_wrap(~var, scales = 'free')+
    theme_few()+
    labs(title = 'Trends')
```

## Scatters

Make scatter plots to put domains in context. Going to pull average each domain for now, will want to pick specific exemplar sites in the near future.


```{r}
#uncomment this if using the v2 dataset from the ms package proper
#ms_site_data <- ms_load_sites()

context <- com %>%
    left_join(., ms_site_data, by = 'site_code') %>%
    filter(water_year %in% 2000:2019,
           site_code %in% unique(trends$site_code)) %>% #only looking at data we have trends for
    mutate(domain = case_when(domain == 'neon' ~ paste0(domain, '_', site_code),
                              domain != 'neon' ~ domain)) %>% # disaggregate neon sites since its national scale
    group_by(domain) %>%
    summarize(flow = mean(m1_meanq, na.rm = T),
              temp = mean(temp_mean_ann, na.rm = T),
              precip = mean(precip_mean_ann, na.rm = T))

ggplot(context, aes(x = temp, y = precip, color = domain)) +
    geom_point()+
    geom_text_repel(aes(label = domain),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 30)+
        theme_few(base_size = 20) +
        theme(legend.position = 'none') +
        labs(x = 'T (mean annual, C)', y = 'Precip (mean annual, mm/d)')+
        scale_color_viridis(discrete = T)
```

```{r}
context %>%
    filter(domain != 'neon_MCDI') %>%
ggplot(., aes(x = precip, y = flow, color = domain)) +
    geom_point()+
    geom_text_repel(aes(label = domain),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 30,
                  force = 20)+
        geom_abline(slope = 1, color = 'red')+
        theme_few(base_size = 20) +
        theme(legend.position = 'none')+
        labs(x = 'Precip (mean annual, mm/d)', y = 'Q (mean annual, mm/d)',
             caption = 'Note: NEON_MCDI off scale Q. (Q 270, P 2.6)')+
        scale_color_viridis(discrete = T)
```

Rainfall runoff ratio to precip. 

```{r}
context %>%
    mutate(runoff_ratio = flow/precip) %>%
    filter(domain != 'neon_MCDI') %>%
ggplot(., aes(x = precip, y = runoff_ratio, color = domain)) +
    geom_point()+
    geom_text_repel(aes(label = domain),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 30,
                  force = 20)+
        geom_hline(yintercept= 1, color = 'red')+
        theme_few(base_size = 20) +
        theme(legend.position = 'none') +
        labs(x = 'Precip (mean annual, mm/d)', y = 'Runoff Ratio',
             caption = 'Note: neon_MCDI off scale (RR 87, P 2.3)')+
        scale_color_viridis(discrete = T)
```

Make another one with neon excluded.

```{r}
context %>%
    mutate(runoff_ratio = flow/precip) %>%
    filter(!grepl('neon', domain)) %>%
ggplot(., aes(x = precip, y = runoff_ratio, color = domain)) +
    geom_point()+
    geom_text_repel(aes(label = domain),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50',
                  max.overlaps = 30,
                  force = 20)+
        theme_few(base_size = 20) +
        theme(legend.position = 'none') +
        labs(x = 'Precip (mean annual, mm/d)', y = 'Runoff Ratio',
             title = 'neon excluded')+
        scale_color_viridis(discrete = T)
```


Re-create part of figure 5 from the CAMEL CHEM data paper (G sterle et al 2024).

Need a vertical boxplot of mean daily precip and Q.

```{r}
context %>%
    pivot_longer(cols = -domain, names_to = 'var', values_to = 'val') %>%
    filter(var == 'flow') %>%
    select(var, val) %>%
    ggplot(., aes(y = val))+
    geom_boxplot()+
    theme_few(base_size = 30)+
    labs(title = 'mean daily Q')+
    scale_y_continuous(breaks = c(0, 2.5, 5, 7.5, 10, 12.5)) # set breaks to match their figure

```


```{r}
context %>%
    pivot_longer(cols = -domain, names_to = 'var', values_to = 'val') %>%
    filter(var == 'precip') %>%
    select(var, val) %>%
    ggplot(., aes(y = val))+
    geom_boxplot()+
    theme_few(base_size = 30)+
    labs(title = 'mean daily P')+
    scale_y_continuous(breaks = c(0, 2.5, 5, 7.5, 10)) # set breaks to match their figure

```

